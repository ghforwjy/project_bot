# 甘特图拖动调整任务顺序解决方案

## 主流设计模式分析

根据对主流项目管理工具（Trello、Jira、Asana、Microsoft Project）的调研，甘特图拖动调整任务顺序的主流设计模式包括：

### 1. 拖动类型
- **垂直拖动**：调整任务顺序（同一项目内的任务重新排序）
- **水平拖动**：调整任务时间（修改开始/结束日期）

### 2. 视觉反馈
- 拖动时显示占位符/阴影
- 显示可放置位置的指示器
- 拖动元素半透明或高亮
- 鼠标指针变化（grab/grabbing）

### 3. 交互模式
- 按住任务条开始拖动
- 拖动过程中实时更新UI
- 释放时保存更改并刷新数据

## 技术实现方案

### 方案选择：使用D3.js的拖拽功能
由于当前甘特图已经使用D3.js渲染，推荐使用D3.js内置的拖拽功能，这样：
- 不需要引入额外的依赖库
- 与现有代码架构一致
- 性能最优

### 实现步骤

#### 1. 前端实现（GanttChart.tsx）

**添加拖拽状态管理**
```typescript
const [draggedTask, setDraggedTask] = useState<any | null>(null);
const [dragOverTask, setDragOverTask] = useState<any | null>(null);
```

**修改任务条渲染函数**
- 添加拖拽事件监听器
- 实现拖拽开始、进行中、结束的处理
- 添加视觉反馈（占位符、高亮等）

**关键交互设计**：
- 拖拽开始：记录拖拽任务，设置拖拽状态
- 拖拽进行：显示占位符，高亮目标位置
- 拖拽结束：更新任务顺序，调用API保存

#### 2. 后端实现（task.py）

**添加批量更新任务顺序的API端点**
```python
@router.put("/projects/{project_id}/tasks/reorder", response_model=ResponseModel)
async def reorder_tasks(project_id: int, task_orders: List[TaskOrder], db: Session = Depends(get_db)):
    """批量更新任务顺序"""
    for task_order in task_orders:
        task = db.query(Task).filter(
            Task.id == task_order.task_id,
            Task.project_id == project_id
        ).first()
        if task:
            task.order = task_order.new_order
    db.commit()
    return ResponseModel(data={"message": "任务顺序更新成功"})
```

#### 3. 前端API服务（projectService.ts）

**添加任务顺序更新方法**
```typescript
async reorderTasks(projectId: number, taskOrders: TaskOrder[]): Promise<any> {
    return await api.put(`/projects/${projectId}/tasks/reorder`, { task_orders: taskOrders })
}
```

## UI/UX设计要点

### 视觉反馈
1. **拖拽开始**：
   - 拖拽元素透明度降低至0.6
   - 显示"正在移动"提示
   - 鼠标指针变为grabbing

2. **拖拽进行中**：
   - 在目标位置显示蓝色占位符
   - 高亮可放置区域
   - 实时计算新位置

3. **拖拽结束**：
   - 显示保存状态
   - 成功后刷新数据
   - 显示成功提示

### 交互优化
1. **防止误操作**：
   - 设置最小拖拽距离（5px）
   - 防止快速点击触发拖拽

2. **性能优化**：
   - 使用requestAnimationFrame优化渲染
   - 拖拽过程中减少重绘

3. **可访问性**：
   - 支持键盘操作（上下箭头调整顺序）
   - 添加ARIA标签

## 修改范围

### 前端文件
1. `frontend/src/components/gantt/GanttChart.tsx` - 添加拖拽功能
2. `frontend/src/services/projectService.ts` - 添加任务顺序更新API

### 后端文件
1. `backend/api/task.py` - 添加任务顺序更新端点
2. `backend/models/schemas.py` - 添加TaskOrder模型

### 类型定义
1. `frontend/src/components/gantt/types.ts` - 添加拖拽相关类型

## 预期效果

用户可以通过以下方式调整任务顺序：
1. **拖拽方式**：按住任务条垂直拖动到新位置
2. **键盘方式**：选中任务后使用上下箭头调整顺序
3. **视觉反馈**：清晰的拖拽指示器和占位符
4. **实时保存**：拖拽结束后自动保存到后端
5. **数据刷新**：保存后自动刷新甘特图显示

## 优势

1. **符合主流习惯**：与Trello、Jira等工具的交互方式一致
2. **直观易用**：拖拽操作直观，学习成本低
3. **性能优化**：基于现有D3.js架构，无需额外依赖
4. **扩展性强**：可以轻松扩展支持水平拖拽调整时间
5. **可访问性**：支持键盘操作，符合无障碍标准