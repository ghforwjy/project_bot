# 项目进度计算算法优化计划

## 问题分析
当前项目进度计算逻辑是简单地将所有任务的进度相加后除以任务数量，这种方法没有考虑到任务的实际时间投入和计划时间的关系，可能导致进度计算不准确。

## 新算法设计
### 核心公式
项目进度 = (所有任务已实际进行的总天数) / (计划需要的总天数) × 100%

### 任务时间计算规则
1. **计划天数计算**：
   - 对于有计划开始和结束日期的任务，计划天数 = 计划结束日期 - 计划开始日期
   - 对于没有计划日期的任务，计划天数 = 0

2. **实际进行天数计算**：
   - 已完成任务：实际结束日期 - 实际开始日期
   - 进行中任务：当前日期 - 实际开始日期
   - 未开始任务：0
   - 对于没有实际开始日期的任务：0

3. **边缘情况处理**：
   - 计划总天数为0时，进度为0%
   - 实际总天数超过计划总天数时，进度 = 实际总天数 / 计划总天数 × 100%（无上限，真实反映拖延情况）
   - 任务没有计划或实际日期时，不影响其他任务的计算

4. **进度与状态关系**：
   - 进度 < 100%：项目进行中/未完成
   - 进度 = 100%：项目已完成
   - 进度 > 100%：项目已拖延，超出计划时间

### 实施步骤

1. **修改项目进度计算函数**：
   - 文件：`backend/api/project.py`
   - 函数：`calculate_project_progress`
   - 替换当前的简单平均算法，实现新的基于时间的计算逻辑

2. **确保任务进度计算的一致性**：
   - 文件：`backend/api/task.py`
   - 函数：`calculate_task_progress`
   - 验证任务进度计算逻辑与新的项目进度计算逻辑是否一致

3. **测试新算法**：
   - 创建测试脚本：`backend/tests/test_project_progress_calculation.py`
   - 测试场景：
     - 所有任务未开始
     - 部分任务进行中
     - 所有任务已完成
     - 任务没有计划日期
     - 任务没有实际日期
     - 实际时间超过计划时间（拖延情况）

4. **验证集成**：
   - 确保新算法在 `update_project_summary` 函数中正常工作
   - 验证通过聊天界面刷新项目状态时，新算法被正确调用

### 预期效果
- 项目进度计算更加准确，反映实际时间投入与计划时间的比例
- 能够处理各种边缘情况，确保计算结果的可靠性
- 当项目拖延时，进度会超过100%，直观体现工期延误
- 与任务进度计算逻辑保持一致，提供统一的进度视图

### 关键改进点
- 移除了150%的上限，让进度值真实反映项目的实际拖延情况
- 基于实际时间和计划时间的比例计算进度，更加合理
- 考虑了各种边缘情况，确保算法的健壮性