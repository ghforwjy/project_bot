# 问题分析

通过分析代码，我发现当更新任务时出现错误，错误信息为"任务 '软件立项与招标' 已存在于项目 '风控系统' 中"。这个错误信息来自于 `project_service.py` 文件中的 `create_task` 方法，这意味着系统在更新任务时错误地调用了创建任务的逻辑。

## 问题原因

1. 在 `chat.py` 文件中，当处理 `update_task` 意图时，错误地调用了 `project_service.create_task` 方法，而不是应该调用的更新任务方法。

2. `project_service.py` 文件中缺少 `update_task` 方法，无法正确处理任务更新操作。

## 解决方案

### 1. 在 `project_service.py` 文件中添加 `update_task` 方法

**核心设计**：直接调用 `task.py` 中的更新任务API，确保功能一致

**具体实现**：
- 方法接受项目名称、任务名称和任务数据作为参数
- 方法先查找项目和任务，获取它们的ID
- 方法直接调用 `task.py` 中的 `update_task` 函数进行实际的更新操作
- 方法返回更新后的任务信息

### 2. 修改 `chat.py` 文件

**核心设计**：修改 `update_task` 意图处理逻辑，调用正确的更新任务方法

**具体实现**：
- 在处理 `update_task` 意图时，调用 `project_service.update_task` 方法，而不是 `create_task` 方法
- 确保传递正确的参数格式

## 详细实施步骤

### 步骤 1：在 `project_service.py` 文件中添加 `update_task` 方法

**目标**：实现 `update_task` 方法，直接调用 `task.py` 中的更新任务逻辑

**具体实现**：

```python
def update_task(self, project_name: str, task_name: str, task_data: Dict) -> Dict:
    """
    更新任务

    Args:
        project_name: 项目名称
        task_name: 任务名称
        task_data: 任务数据

    Returns:
        Dict: 更新后的任务信息
    """
    try:
        # 验证参数
        if not project_name:
            return {
                "success": False,
                "message": "项目名称不能为空",
                "data": None
            }
        
        if not task_name:
            return {
                "success": False,
                "message": "任务名称不能为空",
                "data": None
            }

        # 查找项目
        project = self.db.query(Project).filter(
            Project.name == project_name
        ).first()

        if not project:
            return {
                "success": False,
                "message": f"项目 '{project_name}' 不存在",
                "data": None
            }

        # 查找任务
        task = self.db.query(Task).filter(
            Task.project_id == project.id,
            Task.name == task_name
        ).first()
        
        if not task:
            return {
                "success": False,
                "message": f"任务 '{task_name}' 不存在于项目 '{project_name}' 中",
                "data": None
            }

        # 准备更新数据
        update_data = {}
        if "start_date" in task_data:
            update_data["planned_start_date"] = task_data["start_date"]
        if "end_date" in task_data:
            update_data["planned_end_date"] = task_data["end_date"]
        if "actual_start_date" in task_data:
            update_data["actual_start_date"] = task_data["actual_start_date"]
        if "actual_end_date" in task_data:
            update_data["actual_end_date"] = task_data["actual_end_date"]
        if "assignee" in task_data:
            update_data["assignee"] = task_data["assignee"]
        if "priority" in task_data:
            update_data["priority"] = task_data["priority"]

        # 直接调用 task.py 中的 update_task 函数进行更新
        from api.task import update_task as api_update_task
        from fastapi import Depends
        from models.database import get_db
        
        # 创建 TaskUpdate 对象
        from models.schemas import TaskUpdate
        task_update = TaskUpdate(**update_data)
        
        # 调用 API 函数进行更新
        result = api_update_task(project.id, task.id, task_update, self.db)
        
        return {
            "success": True,
            "message": f"任务 '{task.name}' 更新成功",
            "data": result.data
        }

    except Exception as e:
        self.db.rollback()
        return {
            "success": False,
            "message": f"更新任务失败: {str(e)}",
            "data": None
        }
```

### 步骤 2：修改 `chat.py` 文件

**目标**：修改 `update_task` 意图处理逻辑，调用正确的更新任务方法

**具体实现**：

```python
# 在 handle_update_task 函数中
# 将
result = project_service.create_task(
    project_data.get("project_name"),
    {
        "name": task_data.get("task_name"),
        "start_date": task_data.get("start_date"),
        "end_date": task_data.get("end_date"),
        "assignee": task_data.get("assignee"),
        "priority": task_data.get("priority")
    }
)

# 修改为
result = project_service.update_task(
    project_data.get("project_name"),
    task_data.get("task_name"),
    {
        "start_date": task_data.get("start_date"),
        "end_date": task_data.get("end_date"),
        "actual_start_date": task_data.get("actual_start_date"),
        "actual_end_date": task_data.get("actual_end_date"),
        "assignee": task_data.get("assignee"),
        "priority": task_data.get("priority")
    }
)
```

### 步骤 3：测试修复

**目标**：验证任务更新功能是否正常工作

**具体操作**：
1. 创建测试程序，验证任务更新功能
2. 确保更新任务时不会出现"任务已存在"的错误
3. 确保其他功能不受影响

## 预期结果

- 任务更新功能正常工作，不会出现"任务已存在"的错误
- 系统能够正确区分任务更新和任务创建操作
- 其他功能不受影响
- 直接调用现有的任务更新逻辑，避免代码重复
- 修改范围最小化，只涉及必要的文件和方法