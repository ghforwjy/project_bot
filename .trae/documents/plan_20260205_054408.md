# 改造任务弹框，实现统一的任务添加/编辑功能

## 后台API确认

通过分析现有代码，确认以下后台API已存在：

### 任务相关API
1. **创建任务**：`POST /api/v1/projects/{project_id}/tasks`
2. **更新任务**：`PUT /api/v1/projects/{project_id}/tasks/{task_id}`
3. **获取任务列表**：`GET /api/v1/projects/{project_id}/tasks`
4. **获取项目详情（包含任务）**：`GET /api/v1/projects/{project_id}`

### 任务字段
后台支持的任务字段包括：
- name（任务名称）
- description（任务描述）
- assignee（负责人）
- planned_start_date（计划开始日期）
- planned_end_date（计划结束日期）
- actual_start_date（实际开始日期）
- actual_end_date（实际结束日期）
- progress（进度）
- status（状态）
- priority（优先级）
- deliverable（交付物）

## 改造计划

### 1. 重构TaskModal组件

#### 1.1 创建独立组件
- 将TaskModal从ProjectPanel.tsx中提取为独立组件
- 创建新文件：`frontend/src/components/project/TaskModal.tsx`

#### 1.2 增加编辑模式支持
- 添加props：`mode`（'add'或'edit'）
- 添加props：`taskId`（编辑模式下的任务ID）
- 添加props：`projectId`（项目ID）

#### 1.3 完善任务字段
确保包含所有必要的任务字段：
- 任务名称（必填）
- 任务描述
- 负责人
- 优先级
- 计划开始日期
- 计划结束日期
- 实际开始日期
- 实际结束日期
- 状态
- 交付物

#### 1.4 增加数据加载和保存逻辑
- 编辑模式下，根据taskId加载任务数据
- 统一的表单提交逻辑，区分创建和更新操作
- 使用现有的projectService.createTask和projectService.updateTask方法

### 2. 修改甘特图点击处理

#### 2.1 更新ProjectPanel组件
- 修改handleTaskClick函数，打开TaskModal的编辑模式
- 点击甘特图任务时，传递taskId和projectId给TaskModal

#### 2.2 保持现有功能
- 保持ProjectDetailModal中的任务编辑功能不变
- 保持现有的增加任务入口不变

### 3. 技术实现

#### 3.1 组件结构
```typescript
// TaskModal.tsx
interface TaskModalProps {
  visible: boolean
  mode: 'add' | 'edit'
  projectId: number | null
  taskId?: number | null
  onClose: () => void
}

const TaskModal: React.FC<TaskModalProps> = ({ 
  visible, 
  mode, 
  projectId, 
  taskId, 
  onClose 
}) => {
  // 实现逻辑
}
```

#### 3.2 数据加载
- 编辑模式下，使用useQuery加载任务数据
- 表单初始化时设置默认值

#### 3.3 表单提交
- 根据mode调用不同的API
- 添加模式：projectService.createTask
- 编辑模式：projectService.updateTask

#### 3.4 错误处理
- 统一的错误处理和提示
- 表单验证和数据校验

### 4. 实现步骤

1. **创建独立的TaskModal组件**
   - 提取TaskModal到独立文件
   - 增加编辑模式支持
   - 完善任务字段

2. **修改ProjectPanel组件**
   - 导入新的TaskModal组件
   - 修改handleTaskClick函数
   - 更新TaskModal的使用方式

3. **测试验证**
   - 测试任务添加功能
   - 测试任务编辑功能
   - 测试甘特图点击功能
   - 测试数据验证和错误处理

## 预期效果

1. **统一的任务弹框**：一个弹框同时支持添加和编辑任务
2. **甘特图交互**：点击甘特图任务时弹出编辑框，显示对应任务的详细信息
3. **完整的任务字段**：弹框包含所有必要的任务字段
4. **良好的用户体验**：流畅的任务添加和编辑流程，清晰的错误提示

这个改造将提高用户体验，使任务管理更加直观和高效。