# 统一界面内容刷新方案

## 问题分析
1. **添加任务成功后项目详情面板未刷新**：当创建任务成功后，项目详情面板的数据没有自动更新，需要手动刷新
2. **项目列表页面只有定时刷新**：当前项目列表页面只有30秒的定时刷新，没有事件触发式的刷新方法
3. **数据不同步**：各个组件的数据刷新机制不统一，可能导致界面显示的数据不一致
4. **定时刷新效率低**：定时刷新会在无操作时也频繁请求数据，浪费网络资源和系统性能

## 解决方案

### 1. 统一使用 React Query 的查询失效机制
- **核心思路**：使用 `queryClient.invalidateQueries()` 方法手动失效查询，触发重新获取数据
- **优势**：React Query 会自动处理数据的重新获取和缓存更新，确保界面数据的一致性
- **效率优化**：移除定时刷新，只在必要时触发刷新

### 2. 实现步骤

#### 步骤 1：移除定时刷新
- 在 `ProjectPanel.tsx` 中，修改 `useQuery` 的配置，移除 `refetchInterval` 属性
- 保留 `refetchOnWindowFocus` 属性，确保窗口获得焦点时刷新数据

#### 步骤 2：修改创建任务的 mutation
- 在 `ProjectPanel.tsx` 中，修改 `createTaskMutation` 的 `onSuccess` 回调
- 添加 `queryClient.invalidateQueries()` 调用，同时失效项目列表和项目详情的查询

#### 步骤 3：修改更新项目的 mutation
- 在 `ProjectPanel.tsx` 中，修改 `updateProjectMutation` 的 `onSuccess` 回调
- 添加 `queryClient.invalidateQueries()` 调用，确保项目数据的一致性

#### 步骤 4：添加统一的刷新函数
- 在 `ProjectPanel.tsx` 中添加一个 `refreshAllData` 函数
- 该函数会失效所有相关的查询，触发全面刷新
- 绑定到手动刷新按钮上

#### 步骤 5：修改项目详情面板
- 确保 `DetailSidebar.tsx` 使用正确的查询键
- 当项目数据发生变化时，能够自动响应

### 3. 技术实现

#### 项目列表页面刷新
- **移除定时刷新**：删除 `refetchInterval` 配置
- **添加事件触发刷新**：在数据修改操作后自动触发刷新
- **手动刷新**：提供手动刷新按钮，调用统一的刷新函数
- **窗口焦点刷新**：保留 `refetchOnWindowFocus`，确保窗口获得焦点时刷新数据

#### 项目详情面板刷新
- **自动刷新**：当项目数据发生变化时自动刷新
- **响应式更新**：使用 React Query 的查询失效机制，确保数据的实时性

#### 统一刷新函数
```typescript
const refreshAllData = () => {
  // 失效项目列表查询
  queryClient.invalidateQueries({ queryKey: ['projects'] })
  // 失效项目详情查询
  if (selectedProjectId) {
    queryClient.invalidateQueries({ queryKey: ['project', selectedProjectId] })
  }
  // 可以添加其他需要刷新的查询
}
```

### 4. 预期效果
- **添加任务成功后**：项目详情面板会自动刷新，显示新添加的任务
- **修改项目信息后**：项目列表和项目详情面板会自动刷新，显示更新后的信息
- **统一的刷新机制**：所有数据修改操作都会触发相关组件的刷新，确保数据的一致性
- **手动刷新选项**：保留手动刷新按钮，允许用户在需要时强制刷新所有数据
- **效率优化**：移除定时刷新，减少不必要的网络请求，提高系统性能

### 5. 实施范围
- **前端修改**：
  - `frontend/src/components/project/ProjectPanel.tsx`：移除定时刷新，修改 mutations 和添加刷新函数
  - `frontend/src/components/project/DetailSidebar.tsx`：确保使用正确的查询键

### 6. 测试验证
- 测试添加任务后项目详情面板是否自动刷新
- 测试修改项目信息后项目列表和详情面板是否自动刷新
- 测试手动刷新按钮是否能刷新所有相关数据
- 测试多个组件的数据是否保持一致
- 测试窗口获得焦点时是否自动刷新数据