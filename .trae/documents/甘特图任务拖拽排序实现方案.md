## 目标
实现甘特图任务拖拽调整顺序功能

## 分析结果
1. **现有基础**：Task模型已有order字段，但甘特图API未按order排序
2. **失败原因**：之前代码有语法错误，事件处理冲突，状态管理混乱
3. **正确思路**：使用D3.js drag behavior，正确处理事件链

## 实施步骤

### 步骤1：后端修改
**文件**：backend/api/gantt.py
- 修改任务查询，添加order_by(Task.order)
- 确保任务按order字段排序返回

### 步骤2：类型定义
**文件**：frontend/src/components/gantt/types.ts
- 在GanttTask接口中添加order字段

### 步骤3：前端拖拽实现
**文件**：frontend/src/components/gantt/GanttChart.tsx

**3.1 添加拖拽状态管理**
- 使用单个dragState对象管理拖拽状态
- 避免多个useState导致的复杂性

**3.2 修改renderTask函数**
- 在taskBar创建后，使用.call(d3.drag())添加拖拽行为
- 拖拽事件处理：
  - start: 记录原始Y位置，添加拖拽样式
  - drag: 更新元素Y位置，计算目标位置
  - end: 恢复样式，调用API更新order

**3.3 事件处理策略**
- 拖拽开始时禁用mouseover/mouseout事件
- 使用event.sourceEvent.stopPropagation()防止事件冒泡
- 拖拽结束后恢复所有事件

### 步骤4：API调用
**文件**：frontend/src/services/projectService.ts
- 使用现有的updateTask API更新order字段
- 不需要添加新的reorder API

### 步骤5：样式优化
**文件**：frontend/src/components/gantt/GanttChart.css
- 添加拖拽时的视觉反馈样式
- 添加drag-over样式提示可放置位置

## 关键代码结构

```typescript
// 拖拽状态
const [dragState, setDragState] = useState({
  isDragging: false,
  draggedTask: null,
  startY: 0,
  currentY: 0
});

// 在renderTask中添加拖拽
const taskBar = svg.append('rect')
  // ... 原有属性
  .call(d3.drag()
    .on('start', function(event) {
      event.sourceEvent.stopPropagation();
      setDragState({...});
      // 添加拖拽样式
    })
    .on('drag', function(event) {
      // 更新位置
    })
    .on('end', function(event) {
      // 计算新order，调用API
    })
  );

// 单独绑定其他事件
taskBar.on('mouseover', function() {
  if (dragState.isDragging) return;
  // ... 原有逻辑
});
```

## 测试计划
1. 测试拖拽功能是否正常工作
2. 测试拖拽后任务顺序是否正确保存
3. 测试拖拽时其他事件是否被正确禁用
4. 测试拖拽的视觉反馈是否正常

## 风险控制
1. 先备份现有代码
2. 分步骤实施，每步验证
3. 保留原有事件处理逻辑
4. 添加充分的错误处理