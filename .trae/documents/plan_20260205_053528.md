# 优化任务更新错误处理，显示具体错误原因

## 问题分析

通过分析后端日志，我发现以下问题：

### 错误处理问题
1. **错误信息不清晰**：当任务进度计算出现负数时，后端抛出 500 错误，但没有提供具体的错误信息
2. **数据库约束错误**：负数进度值违反了数据库的 `chk_task_progress` 约束，但错误信息没有明确指出这一点
3. **前端显示不完整**：前端只能显示通用的错误提示，用户无法了解具体的错误原因

## 解决方案

### 1. 优化后端错误处理

修改 `update_task` 接口，添加错误处理，捕获并返回详细的错误信息：

```python
@router.put("/projects/{project_id}/tasks/{task_id}", response_model=ResponseModel)
async def update_task(
    project_id: int,
    task_id: int,
    task_update: TaskUpdate,
    db: Session = Depends(get_db)
):
    """更新任务"""
    from datetime import datetime
    
    try:
        task = db.query(Task).filter(
            Task.id == task_id,
            Task.project_id == project_id
        ).first()
        
        if not task:
            raise HTTPException(status_code=404, detail="任务不存在")
        
        update_data = task_update.dict(exclude_unset=True)
        
        # 处理日期字段
        date_fields = ['planned_start_date', 'planned_end_date', 'actual_start_date', 'actual_end_date']
        for field in date_fields:
            if field in update_data:
                if update_data[field]:
                    update_data[field] = datetime.fromisoformat(update_data[field])
                else:
                    update_data[field] = None
        
        for key, value in update_data.items():
            # 跳过进度字段，始终自动计算
            if key != 'progress':
                setattr(task, key, value)
        
        # 强制自动计算任务进度，无论是否有手动设置
        task.progress = calculate_task_progress(task)
        
        # 验证进度值
        if task.progress < 0 or task.progress > 100:
            raise HTTPException(status_code=400, detail=f"任务进度值无效: {task.progress}，进度值必须在 0-100 之间")
        
        db.commit()
        db.refresh(task)
        
        # 更新项目概要信息
        update_project_summary(project_id, db)
        
        return ResponseModel(data=task.to_dict())
    except HTTPException:
        raise
    except Exception as e:
        # 捕获并返回详细的错误信息
        error_message = str(e)
        if "CHECK constraint failed: chk_task_progress" in error_message:
            raise HTTPException(status_code=400, detail="任务更新失败: 进度值无效，必须在 0-100 之间")
        raise HTTPException(status_code=400, detail=f"任务更新失败: {error_message}")
```

### 2. 确保前端能显示详细错误信息

前端已经修改为显示详细错误信息，确保能正确显示后端返回的具体错误原因。

## 实现步骤

1. 修改 `backend/api/task.py` 文件中的 `update_task` 接口，添加错误处理，捕获并返回详细的错误信息
2. 在进度计算后添加进度值验证，提前发现无效的进度值
3. 测试修改后的功能，确保任务更新失败时能显示具体的错误原因

这个解决方案保持了任务进度计算逻辑不变，只优化了错误处理机制，确保用户能看到清晰的错误信息，了解具体的错误原因。