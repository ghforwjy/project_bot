# 语音输入重复内容问题修复计划

## 问题分析

**核心问题**：
- 后端豆包流式语音识别返回的是完整的句子（如"这个" → "这个任务" → "这个任务的开始时间"）
- 前端每次都将完整句子追加到输入框，导致重复
- 流式返回的是完整句子，不是增量，所以直接追加会造成重复

**根本原因**：
- 在 `ChatPanel.tsx` 中，`handleVoiceResult` 函数被修改为将新的语音识别结果追加到已有内容后面
- 但由于后端每次都发送完整的识别结果，这导致了内容重复

## 修复方案

### 方案：区分语音输入过程和结束状态

**修改文件**：`frontend/src/components/chat/ChatPanel.tsx`

**具体修改**：
1. **修改 `handleVoiceResult` 函数**：
   - 当语音输入正在进行时（`voiceButtonRef.current.isRecording` 为 true），用新的语音识别结果替换整个输入框内容
   - 当语音输入停止后，再次点击语音输入时，将新的语音识别结果追加到已有的内容后面

2. **实现逻辑**：
   - 利用现有的 `voiceButtonRef.current.isRecording` 来判断语音输入是否正在进行
   - 当 `isRecording` 为 true 时，替换输入框内容
   - 当 `isRecording` 为 false 时，追加输入框内容

## 修复步骤

1. **修改 `ChatPanel.tsx` 文件**：
   - 修改 `handleVoiceResult` 函数，实现替换/追加逻辑
   - 确保语音输入过程中的部分结果会替换整个输入框内容
   - 确保语音输入结束后的新输入会追加到已有内容后面

2. **测试验证**：
   - 测试语音输入过程，验证内容不会重复
   - 测试多次语音输入，验证内容会正确追加
   - 测试手工提交后输入框内容是否清空

## 预期效果

- **语音输入过程**：输入框内容实时更新，显示当前完整的识别结果，不会重复
- **多次语音输入**：第一次语音输入结束后，再次点击语音输入，新的识别结果会追加到已有内容后面
- **手工提交**：语音输入会停止，输入框内容会清空

**注意**：修改范围仅限于 `ChatPanel.tsx` 文件中的 `handleVoiceResult` 函数，不会影响其他功能和代码。