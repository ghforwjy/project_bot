# 统一回复格式与前端解析方案

## 需要修改的文件

1. **src/types/index.ts** - 添加统一的类型定义
2. **src/utils/contentParser.ts** - 修改现有解析逻辑
3. **src/utils/messageParser.ts** - 创建统一的消息解析器
4. **src/components/chat/MessageContent.tsx** - 创建统一的消息内容渲染组件
5. **src/components/chat/ChatPanel.tsx** - 重构使用新的解析器和渲染组件
6. **src/components/chat/AnalysisCollapse.tsx** - 修改以适应新的内容类型

## 当前支持的回复格式分析

### 1. content_blocks格式
- **结构**：包含多个内容块，每个块有analysis和content字段
- **特点**：analysis字段可能包含"分析结果:"或"操作结果:"等标记
- **问题**：格式不统一，字段含义不明确

### 2. analysis字段格式
- **结构**：消息对象直接包含analysis字段
- **特点**：analysis字段可能包含"操作结果:"等标记
- **问题**：与content_blocks格式混用，解析逻辑复杂

### 3. 纯content格式
- **结构**：消息对象只有content字段
- **特点**：content字段可能包含JSON代码块和普通文本
- **问题**：需要复杂的正则表达式解析，容易出错

## 存在的问题

1. **格式不统一**：后端返回的格式不一致，导致前端需要处理多种情况
2. **解析逻辑复杂**：前端需要编写复杂的解析逻辑来处理不同的格式
3. **代码复用性差**：解析和渲染逻辑分散在不同的地方，没有统一的处理方式
4. **样式不一致**：不同格式的内容使用不同的样式，导致用户体验不一致
5. **维护困难**：由于格式不统一，修改和维护代码变得困难

## 统一回复格式方案

### 1. 标准回复格式

```json
{
  "code": 200,
  "message": "操作成功",
  "data": {
    "message_id": "123456",
    "session_id": "789012",
    "role": "assistant",
    "content_blocks": [
      {
        "type": "main",
        "content": "我将创建一个名为'投资交易优化'的项目。确认执行吗？",
        "title": "操作确认"
      },
      {
        "type": "data",
        "content": "{\"intent\": \"create_project\", \"data\": {\"name\": \"投资交易优化\"}}\n",
        "title": "数据详情"
      },
      {
        "type": "analysis",
        "content": "我需要确认用户是否要创建这个项目，然后执行创建操作。",
        "title": "分析说明"
      }
    ],
    "timestamp": "2026-02-03T12:00:00Z"
  }
}
```

### 2. 内容类型定义

| 类型 | 描述 | 前端处理方式 |
|------|------|-------------|
| main | 主要内容，直接回答用户的部分 | 直接显示为正文 |
| analysis | 分析说明，对结果的解释和推理 | 显示在可折叠面板中 |
| data | 数据详情，如JSON格式的原始数据 | 显示在可折叠面板中，格式化显示 |
| error | 错误信息，操作失败的提示 | 直接显示为错误信息 |
| confirm | 确认信息，需要用户确认的操作 | 显示确认按钮，等待用户响应 |

## 前端解析方案

### 1. 修改类型定义

**文件：src/types/index.ts**
- 添加ContentBlock接口，包含type、content、title字段
- 扩展ChatMessage接口，支持新的content_blocks格式

### 2. 创建统一的消息解析器

**文件：src/utils/messageParser.ts**
- 实现parseMessage函数，统一处理不同格式的消息
- 整合现有的contentParser.ts中的解析逻辑
- 提供向后兼容，处理旧格式的消息

### 3. 创建统一的消息内容渲染组件

**文件：src/components/chat/MessageContent.tsx**
- 实现MessageContent组件，根据内容类型渲染不同的组件
- 统一处理各种类型的内容块
- 确保样式一致

### 4. 重构ChatPanel组件

**文件：src/components/chat/ChatPanel.tsx**
- 使用新的parseMessage函数解析消息
- 使用MessageContent组件渲染消息内容
- 移除复杂的嵌套条件判断

### 5. 修改AnalysisCollapse组件

**文件：src/components/chat/AnalysisCollapse.tsx**
- 修改组件，支持新的内容类型
- 统一样式，确保与其他组件一致

### 6. 修改内容解析器

**文件：src/utils/contentParser.ts**
- 修改parseContent函数，返回符合新格式的ContentBlock数组
- 保持向后兼容，处理旧格式的内容

## 实施步骤

1. **修改类型定义**：更新src/types/index.ts，添加统一的类型定义
2. **创建消息解析器**：实现src/utils/messageParser.ts，统一处理不同格式的消息
3. **创建消息内容渲染组件**：实现src/components/chat/MessageContent.tsx，统一渲染消息内容
4. **修改AnalysisCollapse组件**：更新src/components/chat/AnalysisCollapse.tsx，支持新的内容类型
5. **重构ChatPanel组件**：使用新的解析器和渲染组件
6. **测试和优化**：测试各种回复格式，确保解析和渲染正确
7. **文档化**：编写文档，说明统一的回复格式和前端处理方案

## 预期效果

1. **格式统一**：后端使用统一的content_blocks格式，前端处理更加简单
2. **代码复用**：提取公共的解析和渲染逻辑，减少代码冗余
3. **样式一致**：所有类型的内容使用统一的样式，提高用户体验
4. **维护方便**：由于格式统一，修改和维护代码变得简单
5. **扩展性强**：新的内容类型可以通过扩展解析器和渲染组件轻松添加
6. **向后兼容**：支持旧格式的消息，确保系统平稳过渡