# 测试程序修正方案

## 存在的问题分析

### 1. 问题描述

从截图中可以看到，确认信息"我将创建一个名为'投资交易优化'的项目。确认执行吗？"被错误地显示在"数据详情"的折叠面板中，而不是作为正文直接显示。

### 2. 测试程序问题

**为什么测试通过**：
- 测试用例没有覆盖这种情况：当content字段包含确认信息时，应该如何处理
- 测试用例只是简单地测试了content字段是文本时的情况，没有测试内容的语义
- 测试用例没有验证内容的显示方式是否正确

## 测试程序修正方案

### 1. 添加测试用例

在`contentParser.test.ts`文件中，添加测试用例，覆盖当content字段包含确认信息的情况：

```typescript
// 测试确认信息内容
test('should detect confirmation content', () => {
  const content = '我将创建一个名为\'投资交易优化\'的项目。确认执行吗？'
  const contentType = detectContentType(content)
  expect(contentType).toBe(ContentType.CONFIRM)
})

// 测试包含确认信息的纯content格式
test('should parse pure content with confirmation', () => {
  const content = '我将创建一个名为\'投资交易优化\'的项目。确认执行吗？'
  const blocks = parseContent(content)
  expect(blocks).toHaveLength(1)
  expect(blocks[0].type).toBe(ContentType.CONFIRM)
  expect(blocks[0].content).toBe('我将创建一个名为\'投资交易优化\'的项目。确认执行吗？')
  expect(blocks[0].title).toBe('确认信息')
})

// 测试包含确认信息的JSON内容
test('should detect confirmation in JSON content', () => {
  const content = '{"message": "我将创建一个名为\'投资交易优化\'的项目。确认执行吗？"}'
  const contentType = detectContentType(content)
  expect(contentType).toBe(ContentType.DATA)
})
```

### 2. 在messageParser.test.ts中添加测试用例

在`messageParser.test.ts`文件中，添加测试用例，覆盖当content字段包含确认信息的情况：

```typescript
// 测试纯content格式包含确认信息
test('should parse pure content with confirmation message', () => {
  const msg: ChatMessage = {
    id: '15',
    role: 'assistant',
    content: '我将创建一个名为\'投资交易优化\'的项目。确认执行吗？',
    timestamp: new Date()
  }
  
  const blocks = parseMessage(msg)
  expect(blocks).toHaveLength(1)
  expect(blocks[0].type).toBe(ContentType.CONFIRM)
  expect(blocks[0].content).toBe('我将创建一个名为\'投资交易优化\'的项目。确认执行吗？')
  expect(blocks[0].title).toBe('确认信息')
})

// 测试content字段是JSON但内容是确认信息
test('should parse JSON content that is confirmation', () => {
  const msg: ChatMessage = {
    id: '16',
    role: 'assistant',
    content: '{"message": "我将创建一个名为\'投资交易优化\'的项目。确认执行吗？"}',
    timestamp: new Date()
  }
  
  const blocks = parseMessage(msg)
  expect(blocks).toHaveLength(1)
  expect(blocks[0].type).toBe(ContentType.DATA)
  expect(blocks[0].content).toBe('{"message": "我将创建一个名为\'投资交易优化\'的项目。确认执行吗？"}')
  expect(blocks[0].title).toBe('数据详情')
})
```

### 3. 修正现有测试用例

修改现有的测试用例，确保它们能够正确测试内容的语义：

```typescript
// 修改测试用例，确保能够检测到内容的语义
test('should parse pure content with text', () => {
  const msg: ChatMessage = {
    id: '11',
    role: 'assistant',
    content: '这是纯文本内容',
    timestamp: new Date()
  }
  
  const blocks = parseMessage(msg)
  expect(blocks).toHaveLength(1)
  expect(blocks[0].type).toBe(ContentType.MAIN)
  expect(blocks[0].content).toBe('这是纯文本内容')
  expect(blocks[0].title).toBe('正文内容')
})
```

## 预期效果

修正测试程序后，当运行测试时，新添加的测试用例将失败，因为当前的代码逻辑会将确认信息错误地标记为MAIN类型。这将帮助我们发现并修复这个问题。

## 总结

1. **测试程序问题**：测试用例没有覆盖当content字段包含确认信息的情况，导致测试通过但实际功能有问题
2. **修正方案**：添加测试用例，覆盖确认信息的情况，确保测试程序能够发现这个问题
3. **预期效果**：测试用例失败，提示开发人员修复代码逻辑，确保确认信息被正确处理和显示