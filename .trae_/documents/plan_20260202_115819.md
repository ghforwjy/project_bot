## 问题分析

### 当前错误
大模型返回："我将把'信创'项目纳入'信创项目大类'。确认执行吗？"

但数据库中：
- 没有"信创"项目
- 没有"信创项目大类"

大模型**没有检查数据库**，直接返回确认提示。

### 问题原因
1. LLM没有查询数据库，不知道哪些项目和类别存在
2. LLM直接用自己的理解回答，没有检查数据是否存在
3. 应该先查询数据库，找到相似的项目和类别供用户选择

## 修改方案

### 核心思路
让LLM在返回确认提示之前，先查询数据库获取可用的项目和类别。

### 修改内容

#### 1. 修改后端chat.py
在发送LLM请求之前，先查询数据库获取项目和类别列表：

```python
# 获取可用的项目和类别列表
project_service = get_project_service(db)
all_projects = project_service.get_all_projects()
all_categories = project_service.get_all_categories()

# 将项目和类别列表传递给LLM
projects_list = [p['name'] for p in all_projects]
categories_list = [c['name'] for c in all_categories]

# 在系统提示词中提供可用选项
system_prompt += f"\n\n当前系统中存在的项目：{projects_list}"
system_prompt += f"\n当前系统中存在的类别：{categories_list}"
```

#### 2. 修改LLM提示词
在系统提示词中添加规则：

```
当用户要求将某个项目纳入某个类别时：
1. 先检查用户提到的项目和类别是否在系统中存在
2. 如果项目不存在但有相似的项目，列出这些项目供用户选择
3. 如果类别不存在但有相似的类别，列出这些类别供用户选择
4. 只有在项目和类别都明确后，才能返回确认提示
```

#### 3. 修改assign_category逻辑
在project_service.py中，当项目或类别不存在时，返回更详细的信息：

```python
def assign_category(self, project_name: str, category_name: str) -> Dict:
    # 1. 检查项目是否存在
    project = self.get_project(project_name)
    if not project['success']:
        # 返回所有可用项目
        all_projects = self.get_all_projects()
        return {
            'success': False,
            'message': f"项目 '{project_name}' 不存在",
            'data': {
                'field': 'project_name',
                'original_value': project_name,
                'available_options': [p['name'] for p in all_projects]
            }
        }
    
    # 2. 检查类别是否存在
    category = self.get_category(category_name)
    if not category['success']:
        # 返回所有可用类别
        all_categories = self.get_all_categories()
        return {
            'success': False,
            'message': f"类别 '{category_name}' 不存在",
            'data': {
                'field': 'category_name',
                'original_value': category_name,
                'available_options': [c['name'] for c in all_categories]
            }
        }
    
    # 3. 执行分配
    ...
```

### 预期效果

**用户输入**："把信创纳入信创项目大类"

**正确响应**：
"我没有找到名为'信创'的项目。当前系统中包含'信创'的项目有：
1. 信创工作
2. 信创工作项目

我没有找到名为'信创项目大类'的类别。当前系统中包含'信创'的类别有：
1. 信创工作大类

请问您指的是哪个项目和类别？"

**用户确认后**（如："把信创工作纳入信创工作大类"）：
"我将把'信创工作'项目纳入'信创工作大类'。确认执行吗？"

**用户再次确认**：
执行assign_category操作。